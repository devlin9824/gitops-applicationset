name: Validate Helm Values
# KÃ­ch hoáº¡t khi cÃ³ ai Ä‘Ã³ Push code hoáº·c táº¡o Pull Request
on:
  push:
    paths:
      - 'apps-config/**' # Chá»‰ cháº¡y khi sá»­a thÆ° má»¥c config (tiáº¿t kiá»‡m tÃ i nguyÃªn)
  pull_request:
    paths:
      - 'apps-config/**'

jobs:
  lint-check:
    runs-on: ubuntu-latest
    steps:
      # 1. Táº£i code tá»« Git vá» mÃ¡y áº£o CI
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. CÃ i Ä‘áº·t Helm lÃªn mÃ¡y áº£o CI
      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.11.1'

      # 3. ThÃªm Repo Bitnami (Giáº£ láº­p mÃ´i trÆ°á»ng cÃ´ng ty)
      # Äá»ƒ cÃ³ cÃ¡i Chart gá»‘c mÃ  so sÃ¡nh
      - name: Add Helm Repo
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      # 4. VÃ’NG Láº¶P KIá»‚M TRA (SCRIPT THáº¦N THÃNH)
      # Script nÃ y sáº½ quÃ©t táº¥t cáº£ thÆ° má»¥c trong apps-config
      # VÃ  thá»­ "nhÃ¡p" (template) xem cÃ³ lá»—i khÃ´ng
      - name: Lint All Apps
        run: |
          echo "Báº¯t Ä‘áº§u kiá»ƒm tra cÃº phÃ¡p..."
          has_error=0

          # Láº·p qua tá»«ng thÆ° má»¥c con trong apps-config (user-service, payment-service...)
          for dir in apps-config/*/; do
            app_name=$(basename "$dir")
            echo "---------------------------------"
            echo "ğŸ” Äang kiá»ƒm tra App: $app_name"
            
            # Lá»‡nh quan trá»ng nháº¥t: Helm Template
            # NÃ³ thá»­ trá»™n values.yaml vÃ o Chart gá»‘c xem cÃ³ ná»• khÃ´ng
            # --debug Ä‘á»ƒ xem lá»—i chi tiáº¿t náº¿u cÃ³
            if helm template test-release bitnami/nginx --version 15.1.2 -f "$dir/values.yaml" > /dev/null; then
              echo "âœ… $app_name: Há»¢P Lá»† (OK)"
            else
              echo "âŒ $app_name: Lá»–I CÃš PHÃP (FAILED)"
              has_error=1
            fi
          done

          echo "---------------------------------"
          # Náº¿u cÃ³ báº¥t ká»³ app nÃ o lá»—i, Ä‘Ã¡nh sáº­p Pipeline luÃ´n
          if [ $has_error -ne 0 ]; then
            echo "ğŸš¨ PHÃT HIá»†N Lá»–I! Dá»«ng quy trÃ¬nh."
            exit 1
          else
            echo "ğŸ‰ Táº¤T Cáº¢ Äá»€U NGON LÃ€NH!"
            exit 0
          fi
